# FX Exposures - Application Integration & Auto-Synchronization

## Overview

FX Exposures has been completely redesigned to integrate seamlessly with the rest of the FX Risk Management platform. The module now operates as a connected component with **automatic exposure synchronization** based on hedging instruments.

## Key Features

### ðŸ”„ **Automatic Exposure Synchronization**
- **Auto-Generation**: Exposures are automatically created from hedging instruments
- **Smart Mapping**: Currency pairs are intelligently mapped to base currencies
- **Hedge Ratio Calculation**: Automatic 100% hedge ratio for generated exposures
- **Real-time Updates**: Instant synchronization when new instruments are imported

### ðŸ”— **Connected Data Flow**
The application now follows this integrated workflow:

```
Strategy Builder â†’ Hedging Instruments â†’ FX Exposures (Auto-Sync)
     â†“                    â†“                       â†“
Create strategies â†’ Export to instruments â†’ Auto-generate exposures â†’ Monitor effectiveness
```

### ðŸ“Š **Enhanced User Experience**
- **Empty State Guidance**: Clear instructions when no exposures exist
- **Auto-Generation Button**: One-click exposure creation from instruments
- **Manual Override**: Option to add exposures manually
- **Real-time Notifications**: Toast messages for auto-generated exposures

## Technical Implementation

### Auto-Synchronization Logic

```typescript
// Auto-generate exposures based on hedging instruments
const autoGenerateExposures = useCallback(() => {
  const currentExposures = serviceRef.current.getExposures();
  const currentInstruments = serviceRef.current.getInstruments();
  
  // Only auto-generate if we have instruments but no exposures
  if (currentInstruments.length > 0 && currentExposures.length === 0) {
    // Group instruments by currency
    const currencyGroups: { [currency: string]: HedgingInstrument[] } = {};
    
    currentInstruments.forEach(instrument => {
      const currency = extractBaseCurrency(instrument.currencyPair);
      if (!currencyGroups[currency]) {
        currencyGroups[currency] = [];
      }
      currencyGroups[currency].push(instrument);
    });
    
    // Create consolidated exposures for each currency
    Object.entries(currencyGroups).forEach(([currency, instruments]) => {
      const totalNotional = instruments.reduce((sum, inst) => sum + inst.notional, 0);
      const avgMaturity = new Date(
        instruments.reduce((sum, inst) => sum + inst.maturity.getTime(), 0) / instruments.length
      );
      
      // Determine exposure type based on instrument types
      const hasReceivableInstruments = instruments.some(inst => 
        inst.type === 'vanilla-call' || inst.type === 'forward' || inst.type === 'collar'
      );
      
      const exposureType: 'receivable' | 'payable' = hasReceivableInstruments ? 'receivable' : 'payable';
      const exposureAmount = exposureType === 'receivable' ? totalNotional : -totalNotional;
      
      // Create auto-exposure with 100% hedge ratio
      const autoExposure: Omit<ExposureData, 'id'> = {
        currency: currency,
        amount: exposureAmount,
        type: exposureType,
        maturity: avgMaturity,
        description: `Auto-generated from ${instruments.length} hedging instrument(s)`,
        subsidiary: 'Auto-Generated',
        hedgeRatio: 100,
        hedgedAmount: exposureAmount
      };
      
      serviceRef.current.addExposure(autoExposure);
    });
    
    // Notify user of auto-generation
    window.dispatchEvent(new CustomEvent('exposuresAutoGenerated', {
      detail: { count: Object.keys(currencyGroups).length }
    }));
  }
}, []);
```

### Currency Pair Mapping

```typescript
// Smart currency extraction from various formats
const extractBaseCurrency = (currencyPair: string): string => {
  // Handle common formats: EUR/USD, EURUSD, EUR-USD
  if (currencyPair.includes('/')) {
    return currencyPair.split('/')[0];
  }
  if (currencyPair.length === 6) {
    return currencyPair.substring(0, 3);
  }
  return currencyPair.substring(0, 3);
};
```

### Event-Driven Updates

```typescript
// Cross-module communication
window.addEventListener('hedgingInstrumentsUpdated', () => {
  syncWithHedgingInstruments();
  autoGenerateExposures();
  refreshAllData();
});

// Auto-generation notifications
window.addEventListener('exposuresAutoGenerated', (event) => {
  const { count } = event.detail;
  toast({
    title: "Exposures Auto-Generated",
    description: `${count} exposure(s) have been automatically created from your hedging instruments.`,
    duration: 5000,
  });
});
```

## User Workflow

### 1. **Automatic Workflow** (Recommended)
1. **Create Strategy**: Build hedging strategy in Strategy Builder
2. **Export Strategy**: Export to Hedging Instruments
3. **Auto-Sync**: Navigate to FX Exposures - exposures are automatically created
4. **Monitor**: View hedge ratios and risk metrics immediately

### 2. **Manual Workflow**
1. **Navigate to FX Exposures**: Start with empty state
2. **Detect Instruments**: System shows available hedging instruments
3. **Click Auto-Generate**: One-click exposure creation
4. **Review & Adjust**: Modify auto-generated exposures as needed

### 3. **Hybrid Workflow**
1. **Auto-Generate Base**: Let system create initial exposures
2. **Manual Additions**: Add additional exposures manually
3. **Continuous Sync**: System maintains synchronization automatically

## Smart Exposure Generation Rules

### Currency Grouping
- **Consolidation**: Multiple instruments in same currency â†’ Single exposure
- **Notional Aggregation**: Sum of all instrument notionals
- **Maturity Averaging**: Weighted average of instrument maturities

### Exposure Type Determination
```typescript
// Logic for determining receivable vs payable
const hasReceivableInstruments = instruments.some(inst => 
  inst.type === 'vanilla-call' ||    // Call options typically for receivables
  inst.type === 'forward' ||         // Forwards can be either direction
  inst.type === 'collar'             // Collars typically for receivables
);

const exposureType = hasReceivableInstruments ? 'receivable' : 'payable';
```

### Hedge Ratio Calculation
- **Initial Setting**: 100% hedge ratio for auto-generated exposures
- **Assumption**: Perfect hedge since instruments exist for the exposure
- **User Override**: Can be manually adjusted after generation

## Benefits

### For Users
- **Zero Configuration**: Exposures appear automatically when instruments exist
- **Intelligent Mapping**: Smart currency and type detection
- **Time Saving**: No manual data entry for basic exposures
- **Consistency**: Guaranteed alignment between instruments and exposures
- **Flexibility**: Can override auto-generation with manual entries

### For Risk Managers
- **Immediate Visibility**: Instant hedge ratio calculations
- **Accurate Reporting**: Real-time risk metrics
- **Compliance Ready**: Automatic documentation of hedge relationships
- **Audit Trail**: Clear linkage between strategies and exposures

### For Developers
- **Event-Driven Architecture**: Reactive updates across modules
- **Type Safety**: Full TypeScript integration with validation
- **Extensible Design**: Easy to add new auto-generation rules
- **Performance Optimized**: Efficient currency grouping and calculation

## Configuration Options

### Auto-Generation Settings
```typescript
// Customize auto-generation behavior
const autoGenerateExposures = (options?: {
  consolidateByCurrency?: boolean;    // Default: true
  defaultHedgeRatio?: number;         // Default: 100
  exposureTypeLogic?: 'smart' | 'manual'; // Default: 'smart'
  includeBarrierOptions?: boolean;    // Default: true
}) => {
  // Implementation with customizable rules
};
```

### Notification Preferences
```typescript
// Control notification behavior
const notificationSettings = {
  showAutoGeneration: true,           // Show when exposures are created
  showSyncUpdates: true,             // Show when instruments sync
  duration: 5000,                    // Toast duration in ms
  position: 'top-right'              // Toast position
};
```

## Troubleshooting

### Common Scenarios

1. **No Auto-Generation Occurring**
   ```javascript
   // Debug checklist
   console.log('Instruments:', instruments.length);
   console.log('Exposures:', exposures.length);
   console.log('Auto-generation triggered:', instruments.length > 0 && exposures.length === 0);
   ```

2. **Incorrect Currency Mapping**
   ```javascript
   // Check currency extraction
   const testPair = 'EURUSD';
   console.log('Extracted currency:', extractBaseCurrency(testPair)); // Should be 'EUR'
   ```

3. **Missing Hedge Ratios**
   ```javascript
   // Verify exposure calculation
   console.log('Hedge ratio calculation:', (hedgedAmount / totalAmount) * 100);
   ```

### Debug Commands
```javascript
// Check auto-generation state
console.log('Auto-generation conditions:', {
  hasInstruments: instruments.length > 0,
  hasExposures: exposures.length > 0,
  shouldAutoGenerate: instruments.length > 0 && exposures.length === 0
});

// Verify event listeners
console.log('Event listeners attached:', {
  hedgingInstrumentsUpdated: !!window.addEventListener,
  exposuresAutoGenerated: !!window.addEventListener
});
```

## Future Enhancements

### Planned Features
- **Advanced Mapping Rules**: Custom currency pair to exposure mapping
- **Partial Hedge Detection**: Smart calculation of partial hedge ratios
- **Multi-Currency Exposures**: Support for cross-currency exposures
- **Historical Sync**: Retroactive exposure generation from historical data

### Enhancement Opportunities
- **Machine Learning**: Predictive exposure type classification
- **Risk-Based Grouping**: Group by risk characteristics, not just currency
- **Dynamic Hedge Ratios**: Real-time hedge effectiveness calculation
- **Integration APIs**: Connect with external treasury systems

## Conclusion

The automatic synchronization feature transforms FX Exposures from a manual data entry tool into an intelligent, connected component of the risk management platform. Users benefit from immediate visibility into hedge effectiveness while maintaining full control over their exposure management process.

The system intelligently bridges the gap between hedging strategies and exposure tracking, providing a seamless workflow that scales from simple single-currency hedges to complex multi-instrument strategies. 